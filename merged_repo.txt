$ErrorActionPreference = "Stop"
$REPO = "C:\xau_rl"
$PY   = "$REPO\.venv\Scripts\python.exe"
$LOG  = "$REPO\logs\services\mini_update_ppo.log"
$LOCK = "$REPO\logs\services\mini_update_ppo.lock"

New-Item -ItemType Directory -Force -Path (Split-Path $LOG) | Out-Null
Set-Location $REPO

function Acquire-Lock { if (Test-Path $LOCK) { $false } else { New-Item -ItemType File -Path $LOCK -Force | Out-Null; $true } }
function Release-Lock { if (Test-Path $LOCK) { Remove-Item $LOCK -Force } }

function Run-Once {
    "`n[$(Get-Date -Format o)] [mini_update] start" | Out-File -FilePath $LOG -Append -Encoding utf8
    & $PY -u "ops\mini_update_ppo.py" "--timesteps" "300000" 1>> $LOG 2>> $LOG
    $code = $LASTEXITCODE
    "[$(Get-Date -Format o)] [mini_update] exit_code=$code" | Out-File -FilePath $LOG -Append -Encoding utf8
    if ($code -ne 0) { throw "mini_update failed with exit_code=$code (see log)" }
    "[$(Get-Date -Format o)] [mini_update] done" | Out-File -FilePath $LOG -Append -Encoding utf8
}

while ($true) {
  try {
    if (Acquire-Lock) {
      Run-Once
      Release-Lock
    } else {
      "`n[$(Get-Date -Format o)] [mini_update] skipped (locked)" | Out-File -FilePath $LOG -Append -Encoding utf8
    }
  } catch {
    "[ERROR] $($_ | Out-String)" | Out-File -FilePath $LOG -Append -Encoding utf8
    Release-Lock
  }
  Start-Sleep -Seconds (6*3600)  # co 6h
}
