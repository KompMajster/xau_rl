# Codzienny raport walidacyjny o 23:00 (eval + report), z lock-file i single bootstrap_alive
$ErrorActionPreference = "Stop"
$REPO = "C:\xau_rl"
$PY   = "$REPO\.venv\Scripts\python.exe"
$LOG  = "$REPO\logs\services\nightly_report.log"
$LOCK = "$REPO\logs\services\nightly_report.lock"

New-Item -ItemType Directory -Force -Path (Split-Path $LOG) | Out-Null
Set-Location $REPO

if (-not (Test-Path $LOG) -or (Get-Item $LOG).Length -eq 0) {
  "[$(Get-Date -Format o)] [nightly_report] bootstrap_alive" | Out-File -FilePath $LOG -Append -Encoding utf8
}

function Acquire-Lock { if (Test-Path $LOCK) { $false } else { New-Item -ItemType File -Path $LOCK -Force | Out-Null; $true } }
function Release-Lock { if (Test-Path $LOCK) { Remove-Item $LOCK -Force } }

function Run-Once {
  & $PY "rl\evaluate.py" "--out_dir" "reports" *>> $LOG
  & $PY "utils\make_report.py"                 *>> $LOG
}

function Seconds-To-Next-2300 {
  $now    = Get-Date
  $target = [DateTime]::Today.AddHours(23)
  if ($now -ge $target) { $target = $target.AddDays(1) }
  return int.TotalSeconds
}

while ($true) {
  Start-Sleep -Seconds (Seconds-To-Next-2300)
  $ts = Get-Date -Format o
  try {
    if (Acquire-Lock) {
      "`n[$ts] [nightly_report] start" | Out-File -FilePath $LOG -Append -Encoding utf8
      Run-Once
      "`n[$(Get-Date -Format o)] [nightly_report] done" | Out-File -FilePath $LOG -Append -Encoding utf8
      Release-Lock
    } else {
      "`n[$ts] [nightly_report] skipped (locked)" | Out-File -FilePath $LOG -Append -Encoding utf8
    }
  } catch {
    "[ERROR] $($_ | Out-String)" | Out-File -FilePath $LOG -Append -Encoding utf8
    Release-Lock
  }
  Start-Sleep -Seconds (24*3600 - 60)
}



# Pełny nightly train (1.5M ts) + eval + report + save/promote o 00:30
$ErrorActionPreference = "Stop"
$REPO = "C:\xau_rl"
$PY   = "$REPO\.venv\Scripts\python.exe"
$LOG  = "$REPO\logs\services\nightly_train.log"
$LOCK = "$REPO\logs\services\nightly_train.lock"

New-Item -ItemType Directory -Force -Path (Split-Path $LOG) | Out-Null
Set-Location $REPO

if (-not (Test-Path $LOG) -or (Get-Item $LOG).Length -eq 0) {
  "[$(Get-Date -Format o)] [nightly_train] bootstrap_alive" | Out-File -FilePath $LOG -Append -Encoding utf8
}

function Acquire-Lock { if (Test-Path $LOCK) { $false } else { New-Item -ItemType File -Path $LOCK -Force | Out-Null; $true } }
function Release-Lock { if (Test-Path $LOCK) { Remove-Item $LOCK -Force } }

function Run-Once {
  & $PY "rl\train_ppo.py" "--timesteps" "1500000" *>> $LOG
  & $PY "rl\evaluate.py" "--out_dir" "reports"    *>> $LOG
  & $PY "utils\make_report.py"                    *>> $LOG
  & $PY "ops\save_candidate.py"                   *>> $LOG
  & $PY "ops\promote_challenger.py"               *>> $LOG
}

function Seconds-To-Next-0030 {
  $now    = Get-Date
  # dziś 00:30 już minęła -> domyślnie jutro 00:30
  $target = [DateTime]::Today.AddDays(1).AddHours(0).AddMinutes(30)
  # jeśli jeszcze przed 00:30 dzisiejszego dnia (teoretycznie przy restarcie ok. północy)
  if ($now.Hour -lt 1 -and ($now.Hour -lt 0 -or ($now.Hour -eq 0 -and $now.Minute -lt 30))) {
    $target = [DateTime]::Today.AddHours(0).AddMinutes(30)
  }
  return int.TotalSeconds
}

while ($true) {
  Start-Sleep -Seconds (Seconds-To-Next-0030)
  $ts = Get-Date -Format o
  try {
    if (Acquire-Lock) {
      "`n[$ts] [nightly_train] start" | Out-File -FilePath $LOG -Append -Encoding utf8
      Run-Once
      "`n[$(Get-Date -Format o)] [nightly_train] done" | Out-File -FilePath $LOG -Append -Encoding utf8
      Release-Lock
    } else {
      "`n[$ts] [nightly_train] skipped (locked)" | Out-File -FilePath $LOG -Append -Encoding utf8
    }
  } catch {
    "[ERROR] $($_ | Out-String)" | Out-File -FilePath $LOG -Append -Encoding utf8
    Release-Lock
  }
  Start-Sleep -Seconds (24*3600 - 60)
}


# Selekcja cech co 3 dni 21:00
$ErrorActionPreference = "Stop"
$REPO = "C:\xau_rl"
$PY   = "$REPO\.venv\Scripts\python.exe"
$LOG  = "$REPO\logs\services\feature_discovery.log"
$LOCK = "$REPO\logs\services\feature_discovery.lock"

New-Item -ItemType Directory -Force -Path (Split-Path $LOG) | Out-Null
Set-Location $REPO

if (-not (Test-Path $LOG) -or (Get-Item $LOG).Length -eq 0) {
  "[$(Get-Date -Format o)] [feature_discovery] bootstrap_alive" | Out-File -FilePath $LOG -Append -Encoding utf8
}

function Acquire-Lock { if (Test-Path $LOCK) { $false } else { New-Item -ItemType File -Path $LOCK -Force | Out-Null; $true } }
function Release-Lock { if (Test-Path $LOCK) { Remove-Item $LOCK -Force } }

function Run-Once {
  & $PY "ops\feature_discovery_weekly.py" "--topK" "96" "--change_frac" "0.10" *>> $LOG
}

function Seconds-To-Next-21 {
  $now    = Get-Date
  $target = [DateTime]::Today.AddHours(21)
  if ($now -ge $target) { $target = $target.AddDays(1) }
  return int.TotalSeconds
}

while ($true) {
  Start-Sleep -Seconds (Seconds-To-Next-21)
  $ts = Get-Date -Format o
  try {
    if (Acquire-Lock) {
      "`n[$ts] [feature_discovery] start" | Out-File -FilePath $LOG -Append -Encoding utf8
      Run-Once
      "`n[$(Get-Date -Format o)] [feature_discovery] done" | Out-File -FilePath $LOG -Append -Encoding utf8
      Release-Lock
    } else {
      "`n[$ts] [feature_discovery] skipped (locked)" | Out-File -FilePath $LOG -Append -Encoding utf8
    }
  } catch {
    "[ERROR] $($_ | Out-String)" | Out-File -FilePath $LOG -Append -Encoding utf8
    Release-Lock
  }
  Start-Sleep -Seconds (3*24*3600 - 60)
}


# Kalibracja kosztów co 3 dni 22:00
$ErrorActionPreference = "Stop"
$REPO = "C:\xau_rl"
$PY   = "$REPO\.venv\Scripts\python.exe"
$LOG  = "$REPO\logs\services\calibration_3d.log"
$LOCK = "$REPO\logs\services\calibration_3d.lock"

New-Item -ItemType Directory -Force -Path (Split-Path $LOG) | Out-Null
Set-Location $REPO

if (-not (Test-Path $LOG) -or (Get-Item $LOG).Length -eq 0) {
  "[$(Get-Date -Format o)] [calibration] bootstrap_alive" | Out-File -FilePath $LOG -Append -Encoding utf8
}

function Acquire-Lock { if (Test-Path $LOCK) { $false } else { New-Item -ItemType File -Path $LOCK -Force | Out-Null; $true } }
function Release-Lock { if (Test-Path $LOCK) { Remove-Item $LOCK -Force } }

function Run-Once { & $PY "utils\calibration.py" "--apply" *>> $LOG }

function Seconds-To-Next-22 {
  $now    = Get-Date
  $target = [DateTime]::Today.AddHours(22)
  if ($now -ge $target) { $target = $target.AddDays(1) }
  return int.TotalSeconds
}

while ($true) {
  Start-Sleep -Seconds (Seconds-To-Next-22)
  $ts = Get-Date -Format o
  try {
    if (Acquire-Lock) {
      "`n[$ts] [calibration] start" | Out-File -FilePath $LOG -Append -Encoding utf8
      Run-Once
      "`n[$(Get-Date -Format o)] [calibration] done" | Out-File -FilePath $LOG -Append -Encoding utf8
      Release-Lock
    } else {
      "`n[$ts] [calibration] skipped (locked)" | Out-File -FilePath $LOG -Append -Encoding utf8
    }
  } catch {
    "[ERROR] $($_ | Out-String)" | Out-File -FilePath $LOG -Append -Encoding utf8
    Release-Lock
  }
  Start-Sleep -Seconds (3*24*3600 - 60)
}


# TE calendar codziennie 05:00 + rebuild features (wymaga TE_API_KEY w env usługi)
$ErrorActionPreference = "Stop"
$REPO = "C:\xau_rl"
$PY   = "$REPO\.venv\Scripts\python.exe"
$LOG  = "$REPO\logs\services\te_calendar.log"
$LOCK = "$REPO\logs\services\te_calendar.lock"

New-Item -ItemType Directory -Force -Path (Split-Path $LOG) | Out-Null
Set-Location $REPO

if (-not (Test-Path $LOG) -or (Get-Item $LOG).Length -eq 0) {
  "[$(Get-Date -Format o)] [te_calendar] bootstrap_alive" | Out-File -FilePath $LOG -Append -Encoding utf8
}

function Acquire-Lock { if (Test-Path $LOCK) { $false } else { New-Item -ItemType File -Path $LOCK -Force | Out-Null; $true } }
function Release-Lock { if (Test-Path $LOCK) { Remove-Item $LOCK -Force } }

function Run-Once {
  & $PY "save_te_calendar_cache.py" *>> $LOG
  & $PY "features\build_features.py" *>> $LOG
}

function Seconds-To-Next-0500 {
  $now    = Get-Date
  $target = [DateTime]::Today.AddHours(5)
  if ($now -ge $target) { $target = $target.AddDays(1) }
  return int.TotalSeconds
}

while ($true) {
  Start-Sleep -Seconds (Seconds-To-Next-0500)
  $ts = Get-Date -Format o
  try {
    if (Acquire-Lock) {
      "`n[$ts] [te_calendar] start" | Out-File -FilePath $LOG -Append -Encoding utf8
      Run-Once
      "`n[$(Get-Date -Format o)] [te_calendar] done" | Out-File -FilePath $LOG -Append -Encoding utf8
      Release-Lock
    } else {
      "`n[$ts] [te_calendar] skipped (locked)" | Out-File -FilePath $LOG -Append -Encoding utf8
    }
  } catch {
    "[ERROR] $($_ | Out-String)" | Out-File -FilePath $LOG -Append -Encoding utf8
    Release-Lock
  }
  Start-Sleep -Seconds (24*3600 - 60)
}
