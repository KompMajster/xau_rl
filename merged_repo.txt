#requires -Version 5.1
<# 
    C:\xau_rl\ops\install_services.ps1
    Instalacja/aktualizacja usługi NSSM dla mini_update_ppo (XAU RL)
#>

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

#region KONFIG
$SERVICE_NAME   = 'XAU_RL_MiniUpdatePPO'
$DISPLAY_NAME   = 'XAU RL - Mini Update PPO'
$DESCRIPTION    = 'Bezpieczny daemon mini-update PPO (single instance, log rotation).'
$BASE_DIR       = 'C:\xau_rl'
$SCRIPT_PATH    = Join-Path $BASE_DIR 'ops\daemon_mini_update.ps1'
$NSSM_EXE       = 'C:\nssm\nssm.exe'    # jeśli nie w PATH, podaj pełną ścieżkę
$POWERSHELL_EXE = "$env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"
#endregion

if (-not (Get-Command $NSSM_EXE -ErrorAction SilentlyContinue)) {
    throw "Nie znaleziono $NSSM_EXE w PATH. Zainstaluj NSSM i podaj pełną ścieżkę."
}
if (-not (Test-Path -LiteralPath $SCRIPT_PATH)) {
    throw "Brak pliku: $SCRIPT_PATH"
}

# Parametry wywołania PowerShell dla usługi
$psArgs = @(
    '-NoProfile',
    '-ExecutionPolicy', 'Bypass',
    '-File', $SCRIPT_PATH
)

# Instaluj lub aktualizuj
Write-Host "Konfiguruję usługę $SERVICE_NAME ..."

# Utwórz/zmień
& $NSSM_EXE install $SERVICE_NAME $POWERSHELL_EXE $psArgs
& $NSSM_EXE set     $SERVICE_NAME DisplayName  $DISPLAY_NAME
& $NSSM_EXE set     $SERVICE_NAME Description  $DESCRIPTION
& $NSSM_EXE set     $SERVICE_NAME AppDirectory $BASE_DIR

# Automatyczny restart na błędach
& $NSSM_EXE set     $SERVICE_NAME Start SERVICE_AUTO_START
& $NSSM_EXE set     $SERVICE_NAME AppStopMethodSkip 0
& $NSSM_EXE set     $SERVICE_NAME AppThrottle 1500
& $NSSM_EXE set     $SERVICE_NAME AppExit Default Restart

# Czyść własne przekierowania NSSM (logi przejmuje skrypt)
& $NSSM_EXE set     $SERVICE_NAME AppStdout ""
& $NSSM_EXE set     $SERVICE_NAME AppStderr ""

# Start/Restart
try {
    & $NSSM_EXE stop  $SERVICE_NAME | Out-Null
} catch {}
& $NSSM_EXE start $SERVICE_NAME | Out-Null

Write-Host "Usługa $SERVICE_NAME została (re)zainstalowana i uruchomiona."
